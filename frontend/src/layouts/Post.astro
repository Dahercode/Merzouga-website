---
import { Container, Button } from '@components/odyssey-theme';
import Layout from './Page.astro';
import { Image } from 'astro:assets';
import { AstroI18next } from 'astro-i18next';
import { Icon } from 'astro-icon/components';
import { t, changeLanguage } from 'i18next';

const {
  content: {
    title,
    description,
    publishDate,
    canonicalURL,
    featuredImage,
  },
} = Astro.props;

const supportedLocales = AstroI18next?.config?.locales ?? [];
const defaultLocale = AstroI18next?.config?.defaultLocale ?? 'en';
const firstPathSegment = Astro.url.pathname.split('/')[1];
const locale = supportedLocales.includes(firstPathSegment)
  ? firstPathSegment
  : defaultLocale;
changeLanguage(locale);
const formattedPublishDate = publishDate
  ? new Intl.DateTimeFormat(locale, {
      month: 'long',
      day: 'numeric',
      year: 'numeric',
    }).format(new Date(publishDate))
  : '';

const seo = {
  title,
  description,
  publishDate,
  canonicalURL,
  image: featuredImage,
};

const validationMessages = {
  firstName: { required: t('tours:validation.firstName.required') },
  lastName: { required: t('tours:validation.lastName.required') },
  email: {
    required: t('tours:validation.email.required'),
    invalid: t('tours:validation.email.invalid'),
  },
  phone: {
    required: t('tours:validation.phone.required'),
    tooShort: t('tours:validation.phone.tooShort'),
    invalid: t('tours:validation.phone.invalid'),
  },
  numberOfPeople: {
    required: t('tours:validation.numberOfPeople.required'),
    minimum: t('tours:validation.numberOfPeople.minimum'),
  },
  startDate: { required: t('tours:validation.startDate.required') },
  endDate: { required: t('tours:validation.endDate.required') },
  dateRange: { invalid: t('tours:validation.dateRange.invalid') },
};
---

<Layout seo={seo}>
  <div class="post-header__container">
    <h1>{title}</h1>
    {
      publishDate && (
        <p class="post-layout__date">
          <time>
            <em>{formattedPublishDate}</em>
          </time>
        </p>
      )
    }
    {
      featuredImage && (
        <Image
          class="post-layout__img"
          src={featuredImage}
          alt={title}
          width={1200}
          height={600}
          loading="eager"
        />
      )
    }
  </div>
  <Container narrow>
    <article id="article">
      <slot />
    </article>
  </Container>
  <section class="booking-cta booking-cta--sticky">
    <div class="booking-cta__copy">
      <p class="booking-cta__eyebrow">{t('tours:booking.lead')}</p>
      <h2>{t('tours:booking.title')}</h2>
      <p class="booking-cta__subtitle">{t('tours:booking.subtitle')}</p>
    </div>
    <div class="booking-cta__action">
      <Button id="booking-open" customIcon data-booking-open>
        {t('tours:booking.cta')}
        <Fragment slot="icon">
          <Icon name="ic:baseline-chevron-right" />
        </Fragment>
      </Button>
    </div>
  </section>
  <div id="booking-modal" class="booking-modal" aria-hidden="true">
    <div class="booking-modal__backdrop" data-booking-close></div>
    <div
      class="booking-modal__dialog"
      role="dialog"
      aria-modal="true"
      aria-labelledby="booking-modal__title"
    >
      <button
        class="booking-modal__close"
        type="button"
        data-booking-close
        aria-label={t('tours:booking.close')}
      >
        x
      </button>
      <div class="booking-modal__head">
        <p class="booking-modal__eyebrow">{t('tours:booking.lead')}</p>
        <h3 id="booking-modal__title">{title}</h3>
        <p class="booking-modal__subtitle">{t('tours:booking.subtitle')}</p>
      </div>
      <form
        id="booking-form"
        class="booking-form"
        data-success={t('tours:booking.success')}
        data-error={t('tours:booking.error')}
        data-tour={title}
        data-locale={locale}
        data-validation-messages={JSON.stringify(validationMessages)}
        novalidate
      >
        <input type="hidden" name="tour" value={title} />
        <div class="booking-form__content">
          <div class="booking-form__grid">
          <div class="booking-form__field">
            <label for="booking-first-name">
              {t('tours:booking.fields.firstName')}
            </label>
            <div class="booking-form__input">
              <Icon name="ic:baseline-person" />
              <input
                id="booking-first-name"
                type="text"
                name="firstName"
                placeholder="Amal"
                required
                autocomplete="given-name"
              />
              <span
                class="booking-form__status-icon"
                data-status-icon="firstName"
                aria-hidden="true"
              >
                ✓
              </span>
            </div>
            <p
              class="booking-form__error"
              data-error-for="firstName"
              role="alert"
            ></p>
          </div>
          <div class="booking-form__field">
            <label for="booking-last-name">
              {t('tours:booking.fields.lastName')}
            </label>
            <div class="booking-form__input">
              <Icon name="ic:baseline-person-outline" />
              <input
                id="booking-last-name"
                type="text"
                name="lastName"
                placeholder="Ben Youssef"
                required
                autocomplete="family-name"
              />
              <span
                class="booking-form__status-icon"
                data-status-icon="lastName"
                aria-hidden="true"
              >
                ✓
              </span>
            </div>
            <p
              class="booking-form__error"
              data-error-for="lastName"
              role="alert"
            ></p>
          </div>
          <div class="booking-form__field">
            <label for="booking-email">{t('tours:booking.fields.email')}</label>
            <div class="booking-form__input">
              <Icon name="ic:baseline-email" />
              <input
                id="booking-email"
                type="email"
                name="email"
                placeholder="voyageur@email.com"
                required
                autocomplete="email"
              />
              <span
                class="booking-form__status-icon"
                data-status-icon="email"
                aria-hidden="true"
              >
                ✓
              </span>
            </div>
            <p
              class="booking-form__error"
              data-error-for="email"
              role="alert"
            ></p>
          </div>
          <div class="booking-form__field booking-form__field--phone">
            <label for="booking-phone">
              {t('tours:booking.fields.phone')}
            </label>
            <phone-input id="booking-phone" required></phone-input>
            <input type="hidden" name="phone" id="phone-hidden" />
          </div>
          <div class="booking-form__field">
            <label for="booking-people">
              {t('tours:booking.fields.people')}
            </label>
            <div class="booking-form__input">
              <Icon name="ic:baseline-groups" />
              <input
                id="booking-people"
                type="number"
                name="people"
                min="1"
                step="1"
                placeholder="2"
                inputmode="numeric"
                required
              />
              <span
                class="booking-form__status-icon"
                data-status-icon="people"
                aria-hidden="true"
              >
                ✓
              </span>
            </div>
            <p
              class="booking-form__error"
              data-error-for="people"
              role="alert"
            ></p>
          </div>
          <div class="booking-form__field booking-form__field--dates">
            <label for="booking-dates">
              {t('tours:booking.fields.startDate')} / {t('tours:booking.fields.endDate')}
            </label>
            <date-range-picker id="booking-dates"></date-range-picker>
            <input type="hidden" name="startDate" id="start-date-hidden" required />
            <input type="hidden" name="endDate" id="end-date-hidden" required />
            <p
              class="booking-form__error"
              data-error-for="dates"
              role="alert"
            ></p>
          </div>
          <div class="booking-form__full">
            <div class="booking-form__field booking-form__field--textarea">
              <label for="booking-message">
                {t('tours:booking.fields.message')}
              </label>
              <div class="booking-form__input booking-form__input--textarea">
                <Icon name="ic:baseline-chat-bubble" />
                <textarea
                  id="booking-message"
                  name="message"
                  placeholder="Préférences, questions..."
                  rows={4}
                ></textarea>
              </div>
            </div>
          </div>
          </div>
        </div>
        <div class="booking-form__actions">
          <Button type="submit" disabled>
            {t('tours:booking.submit')}
          </Button>
        </div>
        <p
          id="booking-status"
          class="booking-status"
          role="status"
          aria-live="polite"
        >
        </p>
      </form>
    </div>
  </div>
</Layout>

<style>
  #article {
    padding-bottom: 8rem;
  }
  .post-header__container {
    max-width: var(--theme-blog-post-header-width);
    margin: 1rem auto;
    padding: var(--container-padding);
  }
  .post-layout__img {
    margin: 0 auto 1rem auto;
    border-radius: var(--theme-shape-radius);
  }
  .post-layout__date {
    margin-bottom: 1rem;
    opacity: 0.84;
  }
  .booking-cta {
    box-sizing: border-box;
    padding: 1.1rem clamp(1.5rem, 3vw, 2.5rem);
    border-radius: var(--theme-shape-radius);
    background:
      linear-gradient(
        135deg,
        color-mix(in srgb, var(--theme-primary) 8%, var(--theme-bg)),
        color-mix(in srgb, var(--theme-primary) 4%, var(--theme-surface-1))
      );
    border: 2px solid color-mix(in srgb, var(--theme-primary) 25%, transparent);
    border-top: 3px solid var(--theme-primary);
    display: grid;
    grid-template-columns: minmax(0, 1.75fr) auto;
    align-items: center;
    gap: 1rem;
    box-shadow:
      0 -10px 28px rgba(0, 0, 0, 0.14),
      0 -2px 8px color-mix(in srgb, var(--theme-primary) 12%, transparent);
    transition: all var(--theme-transition);
  }
  .booking-cta--sticky {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    transform: none;
    width: 100%;
    border-radius: 0;
    padding: 1rem clamp(1.5rem, 4vw, 2.5rem);
    padding-bottom: calc(1rem + env(safe-area-inset-bottom));
    z-index: 1100;
    box-shadow:
      0 -14px 40px rgba(0, 0, 0, 0.18),
      0 -4px 16px color-mix(in srgb, var(--theme-primary) 15%, transparent);
    border-left: none;
    border-right: none;
    border-bottom: none;
  }
  .booking-cta__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0;
    color: var(--theme-primary);
    opacity: 0.95;
  }
  .booking-cta h2 {
    margin: 0.25rem 0 0 0;
    font-size: clamp(1.15rem, 1rem + 0.7vw, 1.5rem);
    line-height: 1.2;
    font-weight: 700;
    color: color-mix(in srgb, var(--theme-on-bg) 95%, var(--theme-primary));
  }
  .booking-cta__subtitle {
    margin: 0.25rem 0 0 0;
    opacity: 0.88;
    font-size: clamp(0.92rem, 0.88rem + 0.35vw, 1.02rem);
    font-weight: 500;
  }
  .booking-cta__action {
    justify-self: end;
  }
  .booking-cta__action :global(.btn) {
    padding: 0.65rem 1.35rem;
    font-size: 1rem;
    font-weight: 600;
    background-color: var(--theme-primary);
    color: var(--theme-on-primary);
    border: none;
    box-shadow:
      0 4px 12px color-mix(in srgb, var(--theme-primary) 35%, transparent),
      0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
  }
  .booking-cta__action :global(.btn:hover) {
    transform: translateY(-1px);
    box-shadow:
      0 6px 16px color-mix(in srgb, var(--theme-primary) 45%, transparent),
      0 3px 6px rgba(0, 0, 0, 0.15);
  }
  .booking-cta__action :global(.btn:active) {
    transform: translateY(0);
  }
  .booking-modal {
    position: fixed;
    inset: 0;
    z-index: 1250;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--theme-transition);
  }
  .booking-modal.is-open {
    opacity: 1;
    pointer-events: auto;
  }
  .booking-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(3px);
  }
  .booking-modal__dialog {
    position: relative;
    max-width: 920px;
    max-height: min(90vh, 920px);
    width: min(920px, 92vw);
    margin: 6vh auto;
    background: var(--theme-bg);
    color: var(--theme-on-bg);
    padding: 2rem;
    border-radius: var(--theme-shape-radius);
    box-shadow: 0 24px 40px rgba(0, 0, 0, 0.18);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-sizing: border-box;
  }
  .booking-modal__close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    color: inherit;
    cursor: pointer;
  }
  .booking-modal__head {
    margin-bottom: 1rem;
  }
  .booking-modal__eyebrow {
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.85rem;
    opacity: 0.8;
  }
  .booking-modal__subtitle {
    margin: 0.25rem 0 0 0;
    opacity: 0.92;
  }
  .booking-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 0;
    height: 100%;
    --form-field-border-focus-color: #00bcd4;
    --form-field-border-error-color: #dc2626;
    --form-field-border-valid-color: #16a34a;
  }
  .booking-form__content {
    flex: 1 1 auto;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding-right: 0.25rem;
    padding-bottom: 2rem;
    scrollbar-width: thin;
    overflow-x: hidden;
  }
  .booking-form__grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem;
    width: 100%;
    box-sizing: border-box;
  }
  .booking-form__field label {
    display: block;
    margin-bottom: 0.35rem;
    font-weight: 600;
  }
  .booking-form__field--phone {
    display: flex;
    flex-direction: column;
  }
  .booking-form__field--phone phone-input {
    width: 100%;
    --theme-primary: var(--form-field-border-focus-color, #00bcd4);
    --form-field-border-color: color-mix(
      in srgb,
      var(--form-field-border-color-base, var(--theme-outline-variant, #d0d0d0)) 70%,
      #cfd6e5
    );
  }
  .booking-form__field--dates {
    /* grid-column: 1 / -1; */
    display: flex;
    flex-direction: column;
  }
  .booking-form__field--dates date-range-picker {
    width: 100%;
    --form-field-border-focus-color: var(--form-field-border-focus-color, #00bcd4);
    --date-valid-color: var(--form-field-border-valid-color, #16a34a);
    --date-error-color: var(--form-field-border-error-color, #dc2626);
    --date-border-color: color-mix(
      in srgb,
      var(--form-field-border-color-base, var(--theme-outline-variant, #d0d0d0)) 70%,
      #cfd6e5
    );
  }
  .booking-form__input {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 0.5rem;
    padding: 0.45rem 0.75rem;
    border: 1px solid
      color-mix(
        in srgb,
        var(--form-field-border-color, var(--theme-outline-variant, #d0d0d0)) 70%,
        #cfd6e5
      );
    border-radius: var(--form-field-border-radius, 0.6rem);
    background: color-mix(
      in srgb,
      var(--theme-surface-1, #ffffff) 12%,
      #ffffff
    );
    transition: border-color var(--theme-transition),
      box-shadow var(--theme-transition);
    color: var(--form-field-input-color, var(--theme-on-surface-1, #1f1f1f));
    box-sizing: border-box;
    min-width: 0;
    max-width: 100%;
    position: relative;
  }
  .booking-form__input:focus-within {
    border-color: var(--form-field-border-focus-color, #00bcd4);
    box-shadow: 0 0 0 3px
      color-mix(in srgb, var(--form-field-border-focus-color, #00bcd4) 18%, transparent);
  }
  .booking-form__input.is-error,
  .booking-form__input.is-error:focus-within {
    border-color: var(--form-field-border-error-color, #dc2626);
    box-shadow: 0 0 0 3px
      color-mix(in srgb, var(--form-field-border-error-color, #dc2626) 18%, transparent);
  }
  .booking-form__input.is-valid,
  .booking-form__input.is-valid:focus-within {
    border-color: var(--form-field-border-valid-color, #16a34a);
    box-shadow: 0 0 0 3px
      color-mix(in srgb, var(--form-field-border-valid-color, #16a34a) 18%, transparent);
  }
  .booking-form__input svg {
    width: 20px;
    height: 20px;
    opacity: 0.7;
    color: color-mix(in srgb, var(--theme-on-surface-2, #4a4a4a) 85%, #7a7a7a);
  }
  .booking-form__input input,
  .booking-form__input textarea {
    border: none;
    outline: none;
    background: transparent;
    width: 100%;
    color: var(--form-field-input-color, var(--theme-on-surface-1, #1f1f1f));
    font-size: 0.95rem;
    line-height: 1.45;
    box-sizing: border-box;
    min-width: 0;
  }
  .booking-form__status-icon {
    font-size: 1.05rem;
    color: var(--form-field-border-valid-color, #16a34a);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    align-self: center;
    justify-self: end;
    width: 1.2rem;
    text-align: right;
    pointer-events: none;
  }
  .booking-form__input.is-valid .booking-form__status-icon {
    opacity: 1;
    visibility: visible;
  }
  .booking-form__input input::placeholder,
  .booking-form__input textarea::placeholder {
    color: color-mix(
      in srgb,
      var(--form-field-input-color, var(--theme-on-surface-1, #1f1f1f)) 48%,
      transparent
    );
  }
  .booking-form__input textarea {
    resize: vertical;
  }
  .booking-form__input--textarea {
    align-items: flex-start;
    grid-template-columns: auto 1fr;
  }
  .booking-form__input--textarea svg {
    margin-top: 0.3rem;
  }
  .booking-form__full {
    grid-column: 1 / -1;
  }
  .booking-form__error {
    margin: 0.35rem 0 0 0;
    font-size: 0.85rem;
    color: var(--form-field-border-error-color, #dc2626);
    font-weight: 500;
    min-height: 1em;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  .booking-form__error:empty {
    min-height: 0;
    display: none;
  }
  .booking-form__error:not(:empty)::before {
    content: '⚠';
    font-size: 0.9rem;
  }
  .booking-form__actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    position: sticky;
    bottom: 0;
    gap: 0.5rem;
    background: var(--theme-bg);
    background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--theme-bg) 92%, transparent),
        var(--theme-bg)
      ),
      var(--theme-bg);
    border-radius: 0 0 var(--theme-shape-radius) var(--theme-shape-radius);
  }
  .booking-form__actions :global(.btn) {
    padding: 0.65rem 1.55rem;
    min-height: 48px;
    align-self: center;
    margin-left: auto;
    background-color: var(--theme-primary);
    color: var(--theme-on-primary);
    border: none;
    box-shadow: 0 8px 18px color-mix(in srgb, var(--theme-primary) 30%, transparent);
    width: 100%;
  }
  .booking-form__actions :global(.btn:disabled) {
    background: #e0e0e0;
    color: #9e9e9e;
    cursor: not-allowed;
    opacity: 0.5;
    box-shadow: none;
  }
  .booking-form__actions :global(.btn:disabled:hover) {
    background: #e0e0e0;
  }
  .booking-status {
    margin: 0;
    font-weight: 500;
    min-height: 1.25rem;
  }
  .booking-status.success {
    color: var(--theme-primary);
  }
  .booking-status.error {
    color: #b3261e;
  }
  @media (max-width: 900px) {
    .booking-cta {
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 0.85rem;
      padding: 1rem clamp(1.25rem, 4vw, 1.75rem);
    }
    .booking-cta h2 {
      font-size: clamp(1.05rem, 0.95rem + 0.9vw, 1.25rem);
    }
    .booking-cta__subtitle {
      font-size: 0.92rem;
    }
    .booking-cta__action {
      justify-self: end;
    }
    .booking-cta__action :global(.btn) {
      padding: 0.6rem 1.2rem;
      font-size: 0.95rem;
    }
    .booking-cta--sticky {
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
    }
    .booking-modal__dialog {
      margin: 4vh 1rem;
      padding: 1.5rem;
    }
    .booking-form__grid {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 550px) {
    .booking-cta {
      grid-template-columns: 1fr;
      text-align: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
    }
    .booking-cta__action {
      justify-self: stretch;
    }
    .booking-cta__action :global(.btn) {
      width: 100%;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
    }
    .booking-cta h2 {
      font-size: 1.05rem;
    }
    .booking-cta__subtitle {
      font-size: 0.9rem;
    }
    .booking-cta--sticky {
      padding: 1rem 1.25rem;
    }
    .booking-modal__dialog {
      padding: 1.1rem;
    }
    .booking-form__input input,
    .booking-form__input textarea {
      line-height: 1.35;
      font-size: 0.93rem;
    }
    .booking-form__actions {
      padding: 0.45rem 0.5rem 0.55rem 0.5rem;
    }
    .booking-form__actions :global(.btn) {
      width: 100%;
      justify-content: center;
      padding: 0.7rem 1.35rem;
      font-size: 1rem;
    }
  }
</style>

<script type="module">
  // Import web components for client-side
  import '/src/components/PhoneInput.js';
  import '/src/components/DateRangePicker.js';

  const modal = document.getElementById('booking-modal');
  const openButtons = Array.from(
    document.querySelectorAll('[data-booking-open]')
  );
  const statusEl = document.getElementById('booking-status');
  const form = document.getElementById('booking-form');
  const tourInput = form?.querySelector("input[name='tour']");
  const phoneInput = document.getElementById('booking-phone');
  const phoneHidden = document.getElementById('phone-hidden');
  const dateRangePicker = document.getElementById('booking-dates');
  const startDateHidden = document.getElementById('start-date-hidden');
  const endDateHidden = document.getElementById('end-date-hidden');
  const firstNameInput = document.getElementById('booking-first-name');
  const lastNameInput = document.getElementById('booking-last-name');
  const emailInput = document.getElementById('booking-email');
  const peopleInput = document.getElementById('booking-people');
  const submitButton = form?.querySelector('button[type="submit"]');
  const defaultTour = form?.dataset.tour || '';
  const successCopy = form?.dataset.success || '';
  const errorCopy = form?.dataset.error || '';
  const locale = form?.dataset.locale || 'en';
  const validationMessages = form?.dataset.validationMessages
    ? JSON.parse(form.dataset.validationMessages)
    : {};
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  let phoneValid = false;

  const toggleModal = (open) => {
    if (!modal) return;
    modal.classList.toggle('is-open', open);
    modal.setAttribute('aria-hidden', open ? 'false' : 'true');
    document.body.style.overflow = open ? 'hidden' : '';
    if (open && tourInput && defaultTour) {
      tourInput.value = defaultTour;
    }
    if (open) {
      hydrateEnhancements();
      updateSubmitButton();
    }
  };

  const hydrateEnhancements = () => {
    // All components are now web components that auto-initialize
  };

  const openModal = (event) => {
    event?.preventDefault();
    toggleModal(true);
  };

  openButtons.forEach((button) => {
    button.addEventListener('click', openModal);
  });
  document.addEventListener('click', (event) => {
    const trigger = event.target.closest('[data-booking-open]');
    if (trigger) {
      openModal(event);
    }
  });
  modal?.querySelectorAll('[data-booking-close]')?.forEach((element) => {
    element.addEventListener('click', () => toggleModal(false));
  });
  window.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      toggleModal(false);
    }
  });

  const setStatusMessage = (message, type = '') => {
    statusEl?.classList.remove('success', 'error');
    if (!statusEl) return;
    statusEl.textContent = message || '';
    if (type) statusEl.classList.add(type);
  };

  const useFormValidation = ({ onStateChange } = {}) => {
    const fields = new Map();

    const hasContent = (value) => {
      if (value === null || value === undefined) return false;
      if (typeof value === 'object') {
        return Object.values(value).some((item) => hasContent(item));
      }
      if (typeof value === 'string') return value.trim() !== '';
      return `${value}`.trim() !== '';
    };

    const applyFieldUI = (field) => {
      const { wrapper, errorEl, statusIcon, status } = field;
      wrapper?.classList.toggle('is-error', status === 'error');
      wrapper?.classList.toggle('is-valid', status === 'valid');
      if (statusIcon) statusIcon.hidden = status !== 'valid';
      if (errorEl) {
        errorEl.textContent = status === 'error' ? field.message || '' : '';
      }
      if (typeof field.setHostStatus === 'function') {
        field.setHostStatus(status, field.message);
      }
    };

    const setFieldState = (name, status, message = '') => {
      const field = fields.get(name);
      if (!field) return;
      field.status = status;
      field.message = message;
      applyFieldUI(field);
      onStateChange?.();
    };

    const registerField = (name, config) => {
      fields.set(name, {
        ...config,
        name,
        status: 'idle',
        message: '',
        touched: false,
      });
      applyFieldUI(fields.get(name));
    };

    const validateField = (name, { isBlur = false, force = false } = {}) => {
      const field = fields.get(name);
      if (!field || typeof field.validate !== 'function') return true;

      if (isBlur) field.touched = true;
      const value = typeof field.getValue === 'function' ? field.getValue() : undefined;
      const result = field.validate(value, {
        touched: field.touched,
        isBlur,
        force,
      });

      let status = result?.status || 'idle';
      let message = result?.message || '';

      if (status === 'error' && !field.touched && !force && !hasContent(value)) {
        status = 'idle';
        message = '';
      }

      setFieldState(name, status, message);
      return status === 'valid';
    };

    const validateAll = () => {
      let allValid = true;
      fields.forEach((_, name) => {
        const valid = validateField(name, { force: true, isBlur: true });
        const field = fields.get(name);
        if (field) field.touched = true;
        if (!valid) allValid = false;
      });
      return allValid;
    };

    const isFormValid = () => {
      let valid = true;
      fields.forEach((field) => {
        if (field.required && field.status !== 'valid') valid = false;
      });
      return valid;
    };

    const reset = () => {
      fields.forEach((field) => {
        field.touched = false;
        setFieldState(field.name, 'idle', '');
      });
    };

    return {
      registerField,
      validateField,
      validateAll,
      isFormValid,
      reset,
    };
  };

  const validation = useFormValidation({ onStateChange: () => updateSubmitButton() });

  const wireField = (name, inputEl) => {
    if (!inputEl) return;
    inputEl.addEventListener('input', () => validation.validateField(name));
    inputEl.addEventListener('blur', () => validation.validateField(name, { isBlur: true }));
  };

  validation.registerField('firstName', {
    required: true,
    wrapper: firstNameInput?.closest('.booking-form__input'),
    errorEl: form?.querySelector('[data-error-for="firstName"]'),
    statusIcon: form?.querySelector('[data-status-icon="firstName"]'),
    getValue: () => firstNameInput?.value?.trim() || '',
    validate: (value) => {
      if (!value) {
        return { status: 'error', message: validationMessages.firstName?.required || '' };
      }
      return { status: 'valid' };
    },
  });
  wireField('firstName', firstNameInput);

  validation.registerField('lastName', {
    required: true,
    wrapper: lastNameInput?.closest('.booking-form__input'),
    errorEl: form?.querySelector('[data-error-for="lastName"]'),
    statusIcon: form?.querySelector('[data-status-icon="lastName"]'),
    getValue: () => lastNameInput?.value?.trim() || '',
    validate: (value) => {
      if (!value) {
        return { status: 'error', message: validationMessages.lastName?.required || '' };
      }
      return { status: 'valid' };
    },
  });
  wireField('lastName', lastNameInput);

  validation.registerField('email', {
    required: true,
    wrapper: emailInput?.closest('.booking-form__input'),
    errorEl: form?.querySelector('[data-error-for="email"]'),
    statusIcon: form?.querySelector('[data-status-icon="email"]'),
    getValue: () => emailInput?.value?.trim() || '',
    validate: (value) => {
      if (!value) {
        return { status: 'error', message: validationMessages.email?.required || '' };
      }
      if (!emailRegex.test(value)) {
        return { status: 'error', message: validationMessages.email?.invalid || '' };
      }
      return { status: 'valid' };
    },
  });
  wireField('email', emailInput);

  validation.registerField('people', {
    required: true,
    wrapper: peopleInput?.closest('.booking-form__input'),
    errorEl: form?.querySelector('[data-error-for="people"]'),
    statusIcon: form?.querySelector('[data-status-icon="people"]'),
    getValue: () => peopleInput?.value,
    validate: (value) => {
      if (value === undefined || value === null || `${value}`.trim() === '') {
        return { status: 'error', message: validationMessages.numberOfPeople?.required || '' };
      }
      const numberValue = Number(value);
      if (!Number.isFinite(numberValue) || numberValue <= 0) {
        return { status: 'error', message: validationMessages.numberOfPeople?.minimum || '' };
      }
      return { status: 'valid' };
    },
  });
  wireField('people', peopleInput);

  validation.registerField('phone', {
    required: true,
    getValue: () => phoneHidden?.value?.trim() || '',
    validate: (value) => {
      if (!value) {
        return { status: 'error', message: validationMessages.phone?.required || '' };
      }
      if (!phoneValid) {
        const fallback = validationMessages.phone?.invalid || '';
        const message =
          phoneInput?.errorMessage ||
          (phoneInput?.validationState === 'error' && fallback) ||
          fallback;
        return { status: 'error', message };
      }
      return { status: 'valid' };
    },
    setHostStatus: (status, message) => {
      if (!phoneInput) return;
      if (status === 'error' && phoneInput.validationState === 'idle') {
        phoneInput.validationState = 'error';
        phoneInput.errorMessage = message || phoneInput.errorMessage;
        phoneInput.requestUpdate();
      }
    },
  });

  validation.registerField('dates', {
    required: true,
    errorEl: form?.querySelector('[data-error-for="dates"]'),
    getValue: () => ({
      start: startDateHidden?.value || '',
      end: endDateHidden?.value || '',
    }),
    validate: (value) => {
      const start = value?.start || '';
      const end = value?.end || '';
      if (!start) {
        return { status: 'error', message: validationMessages.startDate?.required || '' };
      }
      if (!end) {
        return { status: 'error', message: validationMessages.endDate?.required || '' };
      }
      const startDate = new Date(start);
      const endDate = new Date(end);
      if (!(startDate instanceof Date && endDate instanceof Date) || endDate <= startDate) {
        return { status: 'error', message: validationMessages.dateRange?.invalid || '' };
      }
      return { status: 'valid' };
    },
    setHostStatus: (status) => {
      if (!dateRangePicker) return;
      dateRangePicker.classList.toggle('error', status === 'error');
      dateRangePicker.classList.toggle('valid', status === 'valid');
    },
  });

  const updateSubmitButton = () => {
    if (!submitButton) return;
    submitButton.disabled = !validation.isFormValid();
  };

  // Handle phone input changes
  if (phoneInput) {
    phoneInput.addEventListener('phone-change', (e) => {
      phoneHidden.value = e.detail.phone || '';
      phoneValid = e.detail.isValid;
      validation.validateField('phone', { force: true });
    });
    phoneInput.addEventListener('validation-change', (e) => {
      phoneValid = e.detail.isValid;
      validation.validateField('phone', { force: true });
    });
  }

  // Handle date range picker changes
  if (dateRangePicker) {
    dateRangePicker.addEventListener('date-change', (e) => {
      startDateHidden.value = e.detail.startDate || '';
      endDateHidden.value = e.detail.endDate || '';
      validation.validateField('dates', { force: true });
    });
    dateRangePicker.addEventListener('focusout', () =>
      validation.validateField('dates', { isBlur: true, force: true })
    );
  }

  updateSubmitButton();

  const resetInteractiveFields = () => {
    phoneValid = false;
    if (phoneInput) {
      phoneInput.phoneNumber = '';
      phoneInput.validationState = 'idle';
      phoneInput.errorMessage = '';
      phoneInput._touched = false;
      phoneInput.requestUpdate();
    }
    if (dateRangePicker) {
      dateRangePicker.startDate = '';
      dateRangePicker.endDate = '';
      dateRangePicker.isOpen = false;
      dateRangePicker.classList.remove('valid', 'error');
      dateRangePicker.requestUpdate();
    }
    if (startDateHidden) startDateHidden.value = '';
    if (endDateHidden) endDateHidden.value = '';
  };

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!form) return;

    const formIsValid = validation.validateAll();
    updateSubmitButton();
    if (!formIsValid) {
      setStatusMessage('', '');
      return;
    }

    setStatusMessage('', '');
    submitButton && (submitButton.disabled = true);

    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...payload, locale }),
      });
      if (!response.ok) throw new Error('Request failed');
      setStatusMessage(successCopy, 'success');
      form.reset();
      resetInteractiveFields();
      validation.reset();
      if (tourInput && defaultTour) {
        tourInput.value = defaultTour;
      }
    } catch (error) {
      setStatusMessage(errorCopy, 'error');
    } finally {
      submitButton && (submitButton.disabled = !validation.isFormValid());
    }
  });
</script>
