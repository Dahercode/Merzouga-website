---
import { Button } from '@components/odyssey-theme';
import { Image } from 'astro:assets';
import { t } from 'i18next';
import fs from 'fs';
import path from 'path';

// Read images from the gallery directory at build time
const galleryDir = path.join(process.cwd(), 'public/assets/images/gallery');
let images: Array<{ src: string; alt: string; title: string }> = [];

try {
  const files = fs.readdirSync(galleryDir);
  const imageExtensions = ['.jpg', '.jpeg', '.png', '.webp'];

  images = files
    .filter(file => {
      const ext = path.extname(file).toLowerCase();
      return imageExtensions.includes(ext);
    })
    .sort((a: string, b: string) => {
      // Extract numeric part from filenames for proper numeric sorting
      const numA = parseInt(path.basename(a, path.extname(a)));
      const numB = parseInt(path.basename(b, path.extname(b)));
      return numA - numB;
    })
    .map((file, index) => ({
      src: `/assets/images/gallery/${file}`,
      alt: t('gallery:carousel.imageAlt', { index: index + 1 }),
      title: t(`gallery:carousel.images.${index}.title`)
    }));
} catch (error) {
  // Silently handle error
}

const { class: className = '' } = Astro.props;
---

<div class={`gallery-carousel ${className}`}>
  <div class="carousel-wrapper" data-carousel>
    <ul class="carousel-track" data-carousel-track>
      {images.map((image, index) => (
        <li
          class="carousel-slide"
          data-slide-index={index}
          data-slide
        >
          <div class="slide-container">
            <div class="slide-image-wrapper">
              <Image
                src={image.src}
                alt={image.alt}
                loading={index === 0 ? 'eager' : 'lazy'}
                class="slide-image"
                width={1200}
                height={800}
              />
              <div class="slide-overlay" data-overlay></div>
            </div>
            <article class="slide-content" data-content>
              <h2>{image.title}</h2>
              <Button href="/tours" class="explore-btn">
                {t('gallery:carousel.actionButton')}
              </Button>
            </article>
          </div>
        </li>
      ))}
    </ul>

    <div class="carousel-controls">
      <button
        class="carousel-control carousel-control--prev"
        aria-label={t('gallery:carousel.prevButton')}
        data-carousel-prev
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>

      <button
        class="carousel-control carousel-control--next"
        aria-label={t('gallery:carousel.nextButton')}
        data-carousel-next
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<style>
  .gallery-carousel {
    width: 100%;
    margin: var(--section-margin) auto;
    padding-bottom: 10rem;
    perspective: 1200px;
    transform-style: preserve-3d;
    overflow-x: hidden;
  }

  .carousel-wrapper {
    position: relative;
    height: 70vmin;
    margin: 0 auto;
  }

  .carousel-track {
    position: absolute;
    display: flex;
    margin: 0 -4vmin;
    transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
    list-style: none;
    padding: 0;
  }

  .carousel-slide {
    display: flex;
    flex: 1;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    text-align: center;
    color: white;
    opacity: 1;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    width: 70vmin;
    height: 70vmin;
    margin: 0 4vmin;
    z-index: 10;
    transform-origin: bottom;
  }

  .carousel-slide:not(.active) {
    transform: scale(0.98) rotateX(8deg);
  }

  .carousel-slide.active {
    transform: scale(1) rotateX(0deg);
  }

  .slide-container {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .slide-image-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #1D1F2F;
    border-radius: 1%;
    overflow: hidden;
    transition: all 0.15s ease-out;
  }

  .carousel-slide.active .slide-image-wrapper {
    transform: translate3d(var(--x, 0), var(--y, 0), 0);
  }

  .slide-image {
    position: absolute;
    inset: 0;
    width: 120%;
    height: 120%;
    object-fit: cover;
    opacity: 1;
    transition: opacity 0.6s ease-in-out;
  }

  .carousel-slide:not(.active) .slide-image {
    opacity: 0.5;
  }

  .slide-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
    opacity: 0;
    transition: opacity 1s;
  }

  .carousel-slide.active .slide-overlay {
    opacity: 1;
  }

  .slide-content {
    position: relative;
    padding: 4vmin;
    transition: opacity 1s ease-in-out;
    opacity: 0;
    visibility: hidden;
  }

  .carousel-slide.active .slide-content {
    opacity: 1;
    visibility: visible;
  }

  .slide-content h2 {
    font-size: clamp(1.125rem, 3vw, 2.5rem);
    font-weight: 600;
    margin: 0 0 1.5rem 0;
    color: white;
  }

  .slide-content :global(.btn) {
    margin-top: 1.5rem;
    padding: 0.75rem 1.5rem;
    background-color: white;
    color: var(--theme-primary);
    border: 1px transparent;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0px 2px 3px -1px rgba(0,0,0,0.1),
                0px 1px 0px 0px rgba(25,28,33,0.02),
                0px 0px 0px 1px rgba(25,28,33,0.08);
  }

  .slide-content :global(.btn:hover) {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
  }

  .carousel-controls {
    position: absolute;
    display: flex;
    justify-content: center;
    width: 100%;
    top: calc(100% + 4rem);
    margin-bottom: 4rem;
  }

  .carousel-control {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 0.5rem;
    background-color: var(--theme-primary);
    border: 3px solid transparent;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    color: white;
  }

  .carousel-control:hover {
    transform: translateY(-2px);
  }

  .carousel-control:active {
    transform: translateY(2px);
  }

  .carousel-control:focus {
    border-color: #6D64F7;
    outline: none;
  }

  .carousel-control--prev {
    transform: rotate(0deg);
  }

  .carousel-control--prev:hover {
    transform: translateY(-2px) rotate(0deg);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .carousel-wrapper {
      width: 75vmin;
      height: 75vmin;
    }

    .carousel-slide {
      width: 75vmin;
      height: 75vmin;
    }
  }

  @media (max-width: 768px) {
    .gallery-carousel {
      margin: 2rem auto;
      padding-bottom: 8rem;
    }

    .carousel-wrapper {
      width: 85vw;
      height: 85vw;
      max-width: 500px;
      max-height: 500px;
    }

    .carousel-track {
      margin: 0 -2vmin;
    }

    .carousel-slide {
      width: 85vw;
      height: 85vw;
      max-width: 500px;
      max-height: 500px;
      margin: 0 2vmin;
    }

    .slide-content {
      padding: 3vmin;
    }

    .slide-content h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .slide-content :global(.btn) {
      margin-top: 1rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.8125rem;
    }

    .carousel-controls {
      top: calc(100% + 2rem);
      margin-bottom: 2rem;
    }
  }

  @media (max-width: 480px) {
    .gallery-carousel {
      margin: 1rem auto;
      padding-bottom: 6rem;
    }

    .carousel-wrapper {
      width: 95vw;
      height: 95vw;
      max-width: 400px;
      max-height: 400px;
    }

    .carousel-track {
      margin: 0 -1vmin;
    }

    .carousel-slide {
      width: 95vw;
      height: 95vw;
      max-width: 400px;
      max-height: 400px;
      margin: 0 1vmin;
    }

    .slide-content {
      padding: 2vmin;
    }

    .slide-content h2 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    .slide-content :global(.btn) {
      margin-top: 0.75rem;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
    }

    .carousel-control {
      width: 2rem;
      height: 2rem;
    }

    .carousel-controls {
      top: calc(100% + 1.5rem);
      margin-bottom: 1.5rem;
    }
  }

  @media (max-width: 360px) {
    .carousel-wrapper {
      width: 98vw;
      height: 98vw;
    }

    .carousel-slide {
      width: 98vw;
      height: 98vw;
    }

    .slide-content h2 {
      font-size: 0.875rem;
    }

    .carousel-control {
      width: 1.75rem;
      height: 1.75rem;
    }
  }
</style>

<script>
  class GalleryCarousel {
    private wrapper: HTMLElement;
    private track: HTMLElement;
    private slides: NodeListOf<HTMLElement>;
    private prevBtn: HTMLButtonElement;
    private nextBtn: HTMLButtonElement;
    private current: number = 0;
    private xRefs: Map<HTMLElement, { x: number; y: number }> = new Map();
    private frameIds: Map<HTMLElement, number> = new Map();

    constructor(wrapper: HTMLElement) {
      this.wrapper = wrapper;
      this.track = wrapper.querySelector('[data-carousel-track]')!;
      this.slides = wrapper.querySelectorAll('[data-slide]');
      this.prevBtn = wrapper.querySelector('[data-carousel-prev]')!;
      this.nextBtn = wrapper.querySelector('[data-carousel-next]')!;

      this.init();
    }

    private init(): void {
      // Set initial active state
      this.updateSlides();

      // Navigation
      this.prevBtn.addEventListener('click', () => this.handlePrevious());
      this.nextBtn.addEventListener('click', () => this.handleNext());

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') this.handlePrevious();
        if (e.key === 'ArrowRight') this.handleNext();
      });

      // Slide click
      this.slides.forEach((slide, index) => {
        slide.addEventListener('click', () => this.handleSlideClick(index));
      });

      // Mouse move parallax
      this.slides.forEach((slide) => {
        this.xRefs.set(slide, { x: 0, y: 0 });

        slide.addEventListener('mousemove', (e) => this.handleMouseMove(e, slide));
        slide.addEventListener('mouseleave', () => this.handleMouseLeave(slide));

        this.startAnimation(slide);
      });
    }

    private startAnimation(slide: HTMLElement): void {
      const animate = () => {
        const ref = this.xRefs.get(slide);
        if (!ref) return;

        slide.style.setProperty('--x', `${ref.x / 30}px`);
        slide.style.setProperty('--y', `${ref.y / 30}px`);

        const frameId = requestAnimationFrame(animate);
        this.frameIds.set(slide, frameId);
      };

      animate();
    }

    private handleMouseMove(event: MouseEvent, slide: HTMLElement): void {
      const r = slide.getBoundingClientRect();
      const ref = this.xRefs.get(slide);
      if (!ref) return;

      ref.x = event.clientX - (r.left + Math.floor(r.width / 2));
      ref.y = event.clientY - (r.top + Math.floor(r.height / 2));
    }

    private handleMouseLeave(slide: HTMLElement): void {
      const ref = this.xRefs.get(slide);
      if (!ref) return;

      ref.x = 0;
      ref.y = 0;
    }

    private handlePrevious(): void {
      this.current = this.current - 1 < 0 ? this.slides.length - 1 : this.current - 1;
      this.updateSlides();
    }

    private handleNext(): void {
      this.current = this.current + 1 >= this.slides.length ? 0 : this.current + 1;
      this.updateSlides();
    }

    private handleSlideClick(index: number): void {
      if (this.current !== index) {
        this.current = index;
        this.updateSlides();
      }
    }

    private updateSlides(): void {
      // Calculate slide width including margins
      const firstSlide = this.slides[0] as HTMLElement;
      const slideWidth = firstSlide.offsetWidth;
      const slideStyle = getComputedStyle(firstSlide);
      const slideMarginRight = parseInt(slideStyle.marginRight) || 0;
      const slideMarginLeft = parseInt(slideStyle.marginLeft) || 0;
      const totalSlideWidth = slideWidth + slideMarginRight + slideMarginLeft;

      // Update transform using pixel values
      this.track.style.transform = `translateX(-${this.current * totalSlideWidth}px)`;

      // Update active states
      this.slides.forEach((slide, index) => {
        if (index === this.current) {
          slide.classList.add('active');
        } else {
          slide.classList.remove('active');
        }
      });
    }
  }

  // Initialize carousel
  document.addEventListener('DOMContentLoaded', () => {
    const carousels = document.querySelectorAll('[data-carousel]');
    carousels.forEach((carousel) => {
      new GalleryCarousel(carousel as HTMLElement);
    });
  });
</script>
